---
import Layout from '../../layouts/Layout.astro';
import DebugPanel from '../../components/DebugPanel.astro';
import LanguageSelector from '../../components/LanguageSelector.astro';
import { getWebsiteData, getArticles, getCategories } from '../../services/cms';
import { isValidLanguage, getDefaultLanguage } from '../../utils/language';

export async function getStaticPaths() {
  const websiteData = await getWebsiteData();

  if (!websiteData) {
    return [];
  }

  // Generate paths for each available locale
  return websiteData.locales.map(locale => ({
    params: { lang: locale },
  }));
}

const { lang } = Astro.params;
const websiteData = await getWebsiteData();

// Validate language parameter
if (!websiteData || !lang || !isValidLanguage(lang, websiteData.locales)) {
  return Astro.redirect(`/${getDefaultLanguage(websiteData?.locales || ['en'], websiteData?.defaultLocale || 'en')}`);
}

const articles = await getArticles(lang);
const categories = await getCategories(lang);
---

<Layout title="Home">
	{websiteData ? (
		<>
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
				<h1>Welcome to {websiteData.name}</h1>
				<LanguageSelector
					availableLocales={websiteData.locales}
					currentLang={lang}
					currentPath={Astro.url.pathname}
				/>
			</div>

			<p>Site: <strong>{websiteData.apiName}</strong></p>
			<p>Default Locale: <strong>{websiteData.defaultLocale}</strong></p>
			<p>Available Locales: <strong>{websiteData.locales.join(', ')}</strong></p>
			<p>Base URL: <strong>{websiteData.baseUrl}</strong></p>
			<div style={`background-color: ${websiteData.brandColor}; color: white; padding: 1rem; border-radius: 4px; margin: 1rem 0;`}>
				<strong>Brand Color: {websiteData.brandColor}</strong>
			</div>

			<h2>Categories</h2>
			{categories.length > 0 ? (
				<div style="display: flex; gap: 1rem; flex-wrap: wrap; margin: 2rem 0;">
					{categories.map((category) => (
						<div style={`display: inline-block; background-color: ${websiteData.brandColor}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; text-decoration: none;`}>
							{category.name}
						</div>
					))}
				</div>
			) : (
				<p style="color: #6b7280; font-style: italic;">No categories found for this website.</p>
			)}

			<h2>Latest Articles</h2>
			{articles.length > 0 ? (
				<div style="display: grid; gap: 1.5rem; margin: 2rem 0;">
					{articles.map((article) => (
						<article style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; background: #f9fafb;">
							<h3 style="margin: 0 0 0.5rem; color: #111827;">
								<a href={`/articles/${article.slug}`} style={`color: ${websiteData.brandColor}; text-decoration: none;`}>
									{article.title}
								</a>
							</h3>
							{article.excerpt && (
								<p style="color: #6b7280; margin: 0.5rem 0 1rem; line-height: 1.5;">
									{article.excerpt}
								</p>
							)}
							<div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; color: #9ca3af;">
								<span>Updated: {new Date(article.updatedAt).toLocaleDateString()}</span>
							</div>
						</article>
					))}
				</div>
			) : (
				<p style="color: #6b7280; font-style: italic;">No articles found for this website.</p>
			)}
		</>
	) : (
		<>
			<h1>Welcome to Astro</h1>
			<p style="color: #d97706; background: #fef3c7; padding: 1rem; border-radius: 4px;">
				Unable to load website data from CMS. Please check your environment variables.
			</p>
		</>
	)}

	<DebugPanel websiteData={websiteData} articles={articles} additionalInfo={{ "Current Language": lang, "Categories": categories.length, "Category Names": categories.map(c => c.name).join(", ") }} />
</Layout>
